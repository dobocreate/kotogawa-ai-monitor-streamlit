name: Data Collection

on:
  schedule:
    # 10åˆ†ã”ã¨ã«å®Ÿè¡Œ (UTCæ™‚é–“) - æ¯Žæ™‚3åˆ†ã‹ã‚‰é–‹å§‹
    - cron: '3,13,23,33,43,53 * * * *'
    # é–‹ç™ºç”¨è¨­å®š: 1æ™‚é–“ã”ã¨ã«å®Ÿè¡Œ
    # - cron: '3 * * * *'
  workflow_dispatch: # æ‰‹å‹•å®Ÿè¡Œã‚‚å¯èƒ½

permissions:
  contents: write  # ãƒªãƒã‚¸ãƒˆãƒªã¸ã®æ›¸ãè¾¼ã¿æ¨©é™ã‚’ä»˜ä¸Ž

jobs:
  collect-data:
    runs-on: ubuntu-latest
    timeout-minutes: 5
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        persist-credentials: true
        
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
        
    - name: Cache dependencies
      uses: actions/cache@v3
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-v2-${{ hashFiles('**/requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-v2-
          
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        # Force reinstall to avoid cache issues
        pip install --force-reinstall --no-cache-dir -r requirements.txt
        echo "=== Installed packages ==="
        pip list
        echo "=== Python version ==="
        python --version
        echo "=== Checking critical imports ==="
        python -c "import requests; print('âœ“ requests installed')"
        python -c "import bs4; print('âœ“ beautifulsoup4 installed')"
        python -c "import pandas; print('âœ“ pandas installed')"
        
    - name: Configure git
      run: |
        git config --local user.email "41898282+github-actions[bot]@users.noreply.github.com"
        git config --local user.name "github-actions[bot]"
        
    - name: Run data collection
      run: |
        echo "Starting data collection..."
        python scripts/collect_data.py || {
          echo "::error::Data collection failed with exit code $?"
          exit 1
        }
        
    - name: Check for changes
      id: changes
      run: |
        if [[ -n $(git status --porcelain) ]]; then
          echo "has_changes=true" >> $GITHUB_OUTPUT
        else
          echo "has_changes=false" >> $GITHUB_OUTPUT
        fi
        
    - name: Commit and push changes
      if: steps.changes.outputs.has_changes == 'true'
      run: |
        git add data/ scripts/data_timestamp.py
        # äºˆæ¸¬çµæžœã‚‚è¿½åŠ ï¼ˆå­˜åœ¨ã™ã‚‹å ´åˆï¼‰
        if [ -d predictions/ ]; then
          git add predictions/
        fi
        git commit -m "ðŸ“Š Update monitoring data - $(TZ='Asia/Tokyo' date '+%Y-%m-%d %H:%M:%S JST')"
        git pull --rebase origin master
        git push
        
    - name: Run streaming learning with diagnostics
      if: steps.changes.outputs.has_changes == 'true'
      run: |
        # ã‚¹ãƒˆãƒªãƒ¼ãƒ å­¦ç¿’ï¼šéŽåŽ»ã®äºˆæ¸¬ã«å¯¾ã—ã¦ç¾åœ¨ã®å®Ÿæ¸¬å€¤ã§å­¦ç¿’
        echo "Attempting streaming learning with diagnostics..."
        python scripts/streaming_train_with_diagnostics.py || {
          echo "Learning process encountered an issue (exit code: $?)"
          echo "Diagnostics may still have been saved"
        }
        
    - name: Commit model updates and diagnostics
      run: |
        # ãƒ¢ãƒ‡ãƒ«æ›´æ–°ã®ã‚³ãƒŸãƒƒãƒˆ
        if [[ -n $(git status --porcelain models/) ]]; then
          git add models/
          git commit -m "ðŸ¤– Update River model (streaming) - $(TZ='Asia/Tokyo' date '+%Y-%m-%d %H:%M:%S JST')"
          git pull --rebase origin master
          git push
        fi
        
        # è¨ºæ–­çµæžœã®ã‚³ãƒŸãƒƒãƒˆï¼ˆãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªãŒå­˜åœ¨ã™ã‚‹å ´åˆã®ã¿ï¼‰
        if [[ -d diagnostics/ ]] && [[ -n $(git status --porcelain diagnostics/) ]]; then
          git add diagnostics/
          git commit -m "ðŸ” Update learning diagnostics - $(TZ='Asia/Tokyo' date '+%Y-%m-%d %H:%M:%S JST')"
          git pull --rebase origin master
          git push
        fi
        
    - name: Cleanup on failure
      if: failure()
      run: |
        echo "Data collection failed at $(date)"
        # Optional: Create error log
        echo "$(date): Data collection failed" >> data/error.log || true