name: Data Collection

on:
  schedule:
    # æœ¬ç•ªç”¨è¨­å®š: 10åˆ†ã”ã¨ã«å®Ÿè¡Œ (UTCæ™‚é–“) - æ¯Žæ™‚3åˆ†ã‹ã‚‰é–‹å§‹
    # - cron: '3,13,23,33,43,53 * * * *'
    # é–‹ç™ºç”¨è¨­å®š: 1æ™‚é–“ã”ã¨ã«å®Ÿè¡Œ
    - cron: '3 * * * *'
  workflow_dispatch: # æ‰‹å‹•å®Ÿè¡Œã‚‚å¯èƒ½

jobs:
  collect-data:
    runs-on: ubuntu-latest
    timeout-minutes: 5
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        persist-credentials: true
        
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
        
    - name: Cache dependencies
      uses: actions/cache@v3
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-v2-${{ hashFiles('**/requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-v2-
          
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        # Force reinstall to avoid cache issues
        pip install --force-reinstall --no-cache-dir -r requirements.txt
        echo "=== Installed packages ==="
        pip list
        echo "=== Python version ==="
        python --version
        echo "=== Checking critical imports ==="
        python -c "import requests; print('âœ“ requests installed')"
        python -c "import bs4; print('âœ“ beautifulsoup4 installed')"
        python -c "import pandas; print('âœ“ pandas installed')"
        
    - name: Configure git
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        
    - name: Run data collection
      run: |
        echo "Starting data collection..."
        python scripts/collect_data.py || {
          echo "::error::Data collection failed with exit code $?"
          exit 1
        }
        
    - name: Check for changes
      id: changes
      run: |
        if [[ -n $(git status --porcelain) ]]; then
          echo "has_changes=true" >> $GITHUB_OUTPUT
        else
          echo "has_changes=false" >> $GITHUB_OUTPUT
        fi
        
    - name: Commit and push changes
      if: steps.changes.outputs.has_changes == 'true'
      run: |
        git add data/
        git commit -m "ðŸ“Š Update monitoring data - $(date '+%Y-%m-%d %H:%M:%S UTC')"
        git pull --rebase origin master
        git push
        
    - name: Run streaming learning with diagnostics (3 hours after data point)
      if: steps.changes.outputs.has_changes == 'true'
      run: |
        # 3æ™‚é–“å‰ã®ãƒ‡ãƒ¼ã‚¿ã§å­¦ç¿’ã‚’è©¦ã¿ã‚‹ï¼ˆå®Ÿæ¸¬å€¤ãŒæƒã£ã¦ã„ã‚‹ãŸã‚ï¼‰
        echo "Attempting streaming learning with diagnostics..."
        python scripts/streaming_train_with_diagnostics.py || echo "Learning skipped (no future data available yet)"
        
    - name: Commit model updates and diagnostics
      run: |
        # ãƒ¢ãƒ‡ãƒ«æ›´æ–°ã®ã‚³ãƒŸãƒƒãƒˆ
        if [[ -n $(git status --porcelain models/) ]]; then
          git add models/
          git commit -m "ðŸ¤– Update River model (streaming) - $(date '+%Y-%m-%d %H:%M:%S UTC')"
          git pull --rebase origin master
          git push
        fi
        
        # è¨ºæ–­çµæžœã®ã‚³ãƒŸãƒƒãƒˆ
        if [[ -n $(git status --porcelain diagnostics/) ]]; then
          git add diagnostics/
          git commit -m "ðŸ” Update learning diagnostics - $(date '+%Y-%m-%d %H:%M:%S UTC')"
          git pull --rebase origin master
          git push
        fi
        
    - name: Cleanup on failure
      if: failure()
      run: |
        echo "Data collection failed at $(date)"
        # Optional: Create error log
        echo "$(date): Data collection failed" >> data/error.log || true